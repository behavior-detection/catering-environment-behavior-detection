<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è§„æ•°æ®ç›‘æ§ - YOLOæ£€æµ‹ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* ç­›é€‰æ§åˆ¶é¢æ¿ */
        .filter-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .filter-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-body {
            padding: 25px;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-range-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .time-range-btn {
            padding: 12px 8px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .time-range-btn:hover {
            border-color: #667eea;
            background: #fff;
        }

        .time-range-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e5e9;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .filter-status {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 12px 15px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #1565c0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* å›¾è¡¨å¸ƒå±€ */
        .charts-section {
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chart-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-body {
            padding: 20px;
            height: 350px;
        }

        .chart-container {
            width: 100%;
            height: 100%;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .panel-body {
            padding: 25px;
        }

        /* ç»Ÿä¸€çš„åˆ—è¡¨æ ·å¼ */
        .unified-list {
            list-style: none;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .list-item:last-child {
            margin-bottom: 0;
        }

        .item-info {
            display: flex;
            flex-direction: column;
        }

        .item-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }

        .item-stats {
            font-size: 0.85em;
            color: #6c757d;
        }

        .item-count {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        /* ç‰¹æ®Šçš„è¿è§„è®¡æ•°æ ·å¼ */
        .violation-count {
            background: #dc3545;
        }

        .recent-records {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
        }

        .records-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .records-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .records-table tbody tr:hover {
            background: #f8f9fa;
        }

        .timestamp {
            color: #6c757d;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            width: 30px;
            height: 30px;
            margin: 0 auto 15px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .time-range-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }

            .records-table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¿è§„æ•°æ®ç›‘æ§ç³»ç»Ÿ</h1>
            <p>åŸºäºYOLOæ£€æµ‹çš„å®æ—¶è¿è§„è¡Œä¸ºåˆ†æ</p>
        </div>

        <!-- ç­›é€‰æ§åˆ¶é¢æ¿ -->
        <div class="filter-panel">
            <div class="filter-header">
                <span>ğŸ”</span>
                <span>æ•°æ®ç­›é€‰æ§åˆ¶é¢æ¿</span>
                <span id="lastUpdate" class="timestamp" style="margin-left: auto;">æœ€åæ›´æ–°: --</span>
            </div>
            <div class="filter-body">
                <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
                <div class="filter-section">
                    <div class="filter-label">
                        <span>ğŸ“…</span>
                        <span>æ—¶é—´èŒƒå›´é€‰æ‹©</span>
                    </div>
                    <div class="time-range-grid">
                        <div class="time-range-btn" data-range="1h">
                            <div style="font-weight: 600;">1å°æ—¶</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">æœ€è¿‘1å°æ—¶</div>
                        </div>
                        <div class="time-range-btn active" data-range="24h">
                            <div style="font-weight: 600;">24å°æ—¶</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">æœ€è¿‘1å¤©</div>
                        </div>
                        <div class="time-range-btn" data-range="7d">
                            <div style="font-weight: 600;">7å¤©</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">æœ€è¿‘ä¸€å‘¨</div>
                        </div>
                        <div class="time-range-btn" data-range="30d">
                            <div style="font-weight: 600;">30å¤©</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">æœ€è¿‘ä¸€æœˆ</div>
                        </div>
                        <div class="time-range-btn" data-range="all">
                            <div style="font-weight: 600;">å…¨éƒ¨</div>
                            <div style="font-size: 0.8em; opacity: 0.8;">æ‰€æœ‰æ•°æ®</div>
                        </div>
                    </div>
                </div>

                <!-- ç­›é€‰çŠ¶æ€æ˜¾ç¤º -->
                <div class="filter-status" id="filterStatus">
                    <span>â„¹ï¸</span>
                    <span id="filterStatusText">å½“å‰ç­›é€‰ï¼šæ˜¾ç¤ºæœ€è¿‘24å°æ—¶æ•°æ®</span>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
                    </button>
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        <span>â†©ï¸</span> é‡ç½®ç­›é€‰
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <span>ğŸ—‘ï¸</span> æ¸…ç©ºæ•°æ®
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalViolations">--</div>
                <div class="stat-label">æ€»è¿è§„æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRecords">--</div>
                <div class="stat-label">æ£€æµ‹è®°å½•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeCameras">--</div>
                <div class="stat-label">æ´»è·ƒæ‘„åƒå¤´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgViolations">--</div>
                <div class="stat-label">å¹³å‡è¿è§„/è®°å½•</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-section">
            <div class="charts-grid">
                <div class="chart-panel">
                    <div class="chart-header">
                        <span>è¿è§„ç±»å‹åˆ†å¸ƒå›¾</span>
                        <span id="violationPieInfo">--</span>
                    </div>
                    <div class="chart-body">
                        <div id="violationPieChart" class="chart-container"></div>
                    </div>
                </div>

                <div class="chart-panel">
                    <div class="chart-header">
                        <span>æ‘„åƒå¤´è¿è§„åˆ†å¸ƒå›¾</span>
                        <span id="cameraCompareInfo">--</span>
                    </div>
                    <div class="chart-body">
                        <div id="cameraCompareChart" class="chart-container"></div>
                    </div>
                </div>

                <div class="chart-panel">
                    <div class="chart-header">
                        <span>24å°æ—¶è¿è§„åˆ†å¸ƒå›¾</span>
                        <span id="hourlyDistributionInfo">--</span>
                    </div>
                    <div class="chart-body">
                        <div id="hourlyDistributionChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="panel">
                <div class="panel-header">è¿è§„ç±»å‹ç»Ÿè®¡</div>
                <div class="panel-body">
                    <ul class="unified-list" id="violationsList">
                        <li class="loading">
                            <div class="spinner"></div>
                            <div>åŠ è½½ä¸­...</div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">æ‘„åƒå¤´ç»Ÿè®¡</div>
                <div class="panel-body">
                    <ul class="unified-list" id="camerasList">
                        <li class="loading">
                            <div class="spinner"></div>
                            <div>åŠ è½½ä¸­...</div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- AIæŸ¥è¯¢é¢æ¿ -->
        <div class="panel" style="margin-bottom: 30px;">
            <div class="panel-header">æ™ºèƒ½æŸ¥è¯¢åŠ©æ‰‹</div>
            <div class="panel-body">
                <div class="query-section">
                    <div class="query-input-wrapper" style="position: relative; margin-bottom: 15px;">
                        <textarea class="query-input" id="aiQueryInput"
                                  placeholder="è¯·ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä»Šå¤©å“ªä¸ªåŒºåŸŸè¿è§„æœ€å¤šï¼Ÿå£ç½©ä½©æˆ´æƒ…å†µå¦‚ä½•ï¼Ÿ"
                                  rows="2" style="width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; resize: vertical; outline: none; transition: border-color 0.3s ease;"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                        <button class="btn btn-primary" onclick="submitAIQuery()" id="queryBtn">
                            AIåˆ†æ
                        </button>
                        <button class="btn btn-secondary" onclick="clearAIQuery()">
                            æ¸…ç©º
                        </button>
                        <select class="select" id="queryTimeRange" style="margin-left: auto; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; background: white; font-size: 14px;">
                            <option value="1">æœ€è¿‘1å°æ—¶</option>
                            <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                            <option value="48">æœ€è¿‘48å°æ—¶</option>
                            <option value="168">æœ€è¿‘7å¤©</option>
                            <option value="720">æœ€è¿‘30å¤©</option>
                            <option value="0">æ‰€æœ‰æ•°æ®</option>
                        </select>
                    </div>

                    <!-- å¿«é€ŸæŸ¥è¯¢ç¤ºä¾‹ -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">å¿«é€ŸæŸ¥è¯¢:</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                                    onclick="setAIQuery('ä»Šå¤©è¿è§„æƒ…å†µå¦‚ä½•ï¼Ÿ')">ä»Šå¤©è¿è§„æƒ…å†µ</button>
                            <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                                    onclick="setAIQuery('å“ªä¸ªæ‘„åƒå¤´è¿è§„æœ€å¤šï¼Ÿ')">è¿è§„çƒ­ç‚¹</button>
                            <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                                    onclick="setAIQuery('å£ç½©ä½©æˆ´æƒ…å†µæ€ä¹ˆæ ·ï¼Ÿ')">å£ç½©åˆè§„</button>
                            <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                                    onclick="setAIQuery('å½“å‰é£é™©ç­‰çº§å¦‚ä½•ï¼Ÿéœ€è¦é‡‡å–ä»€ä¹ˆæªæ–½ï¼Ÿ')">é£é™©è¯„ä¼°</button>
                            <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;"
                                    onclick="setAIQuery('æœ€è¿‘ä¸€å‘¨çš„è¿è§„è¶‹åŠ¿å˜åŒ–')">è¶‹åŠ¿åˆ†æ</button>
                        </div>
                    </div>

                    <!-- AIåˆ†æç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="aiAnalysisResult" style="display: none;">
                        <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #495057; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                AIåˆ†æç»“æœ
                            </h4>
                            <div id="aiResultContent">
                                <!-- ç»“æœå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="recent-records">
            <div class="panel-header">æœ€è¿‘æ£€æµ‹è®°å½•</div>
            <div class="panel-body">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>æ‘„åƒå¤´ID</th>
                            <th>æ£€æµ‹æ—¶é—´</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>è¿è§„æ¬¡æ•°</th>
                            <th>è¿è§„ç±»å‹</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                <div>åŠ è½½ä¸­...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const JANUS_API_URL = 'http://localhost:5001/api';

        // è¿è§„ç±»å‹ä¸­æ–‡æ˜ å°„
        const violationMapping = {
            'mask': 'æœªä½©æˆ´å£ç½©',
            'hat': 'æœªä½©æˆ´å·¥ä½œå¸½',
            'phone': 'ä½¿ç”¨æ‰‹æœº',
            'cigarette': 'å¸çƒŸè¡Œä¸º',
            'mouse': 'é¼ æ‚£é—®é¢˜',
            'uniform': 'å·¥ä½œæœè¿è§„',
            'person': 'äººå‘˜æ£€æµ‹',
            'no_mask': 'æœªä½©æˆ´å£ç½©',
            'no_hat': 'æœªä½©æˆ´å·¥ä½œå¸½',
            'phone_usage': 'ä½¿ç”¨æ‰‹æœº',
            'smoking': 'å¸çƒŸè¡Œä¸º',
            'mouse_infestation': 'é¼ æ‚£é—®é¢˜',
            'uniform_violation': 'å·¥ä½œæœè¿è§„',
            'unknown': 'æœªçŸ¥è¿è§„'
        };

        // è¿è§„ç±»å‹é¢œè‰²æ˜ å°„
        const violationColors = {
            'mask': '#FF6B6B',
            'hat': '#4ECDC4',
            'phone': '#45B7D1',
            'cigarette': '#96CEB4',
            'mouse': '#FFEAA7',
            'uniform': '#DDA0DD',
            'person': '#A8E6CF',
            'no_mask': '#FF6B6B',
            'no_hat': '#4ECDC4',
            'phone_usage': '#45B7D1',
            'smoking': '#96CEB4',
            'mouse_infestation': '#FFEAA7',
            'uniform_violation': '#DDA0DD',
            'unknown': '#999999'
        };

        // å½“å‰ç­›é€‰çŠ¶æ€
        let currentFilter = {
            timeRange: '24h'
        };

        // å›¾è¡¨å®ä¾‹
        let violationPieChart = null;
        let cameraCompareChart = null;
        let hourlyDistributionChart = null;

        // å…¨å±€æ•°æ®å­˜å‚¨
        let globalData = null;
        let isLoading = false;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            initializeCharts();
            loadData();

            // è®¾ç½®å®šæœŸåˆ·æ–°
            setInterval(() => {
                if (!isLoading) {
                    loadData();
                }
            }, 60000);

            // æŸ¥è¯¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('aiQueryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitAIQuery();
                }
            });
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initializeCharts() {
            violationPieChart = echarts.init(document.getElementById('violationPieChart'));
            cameraCompareChart = echarts.init(document.getElementById('cameraCompareChart'));
            hourlyDistributionChart = echarts.init(document.getElementById('hourlyDistributionChart'));

            window.addEventListener('resize', function() {
                violationPieChart.resize();
                cameraCompareChart.resize();
                hourlyDistributionChart.resize();
            });
        }

        // åˆå§‹åŒ–ç­›é€‰å™¨
        function initializeFilters() {
            document.querySelectorAll('[data-range]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-range]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter.timeRange = this.dataset.range;
                    updateFilterStatus();
                });
            });

            updateFilterStatus();
        }

        // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
        function updateFilterStatus() {
            let rangeText = '';

            switch(currentFilter.timeRange) {
                case '1h':
                    rangeText = 'æœ€è¿‘1å°æ—¶';
                    break;
                case '24h':
                    rangeText = 'æœ€è¿‘24å°æ—¶';
                    break;
                case '7d':
                    rangeText = 'æœ€è¿‘7å¤©';
                    break;
                case '30d':
                    rangeText = 'æœ€è¿‘30å¤©';
                    break;
                case 'all':
                    rangeText = 'æ‰€æœ‰æ•°æ®';
                    break;
            }

            document.getElementById('filterStatusText').textContent = `å½“å‰ç­›é€‰ï¼š${rangeText}`;
        }

        // åº”ç”¨ç­›é€‰å™¨
        function applyFilters() {
            if (!isLoading) {
                loadData();
            }
        }

        // é‡ç½®ç­›é€‰å™¨
        function resetFilters() {
            document.querySelectorAll('[data-range]').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-range="24h"]').classList.add('active');

            currentFilter = {
                timeRange: '24h'
            };

            updateFilterStatus();
            if (!isLoading) {
                loadData();
            }
            showMessage('ç­›é€‰æ¡ä»¶å·²é‡ç½®', 'info');
            setTimeout(() => clearMessages(), 3000);
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            if (isLoading) {
                console.log('âš ï¸ æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                return;
            }

            isLoading = true;

            try {
                console.log('ğŸ“¡ å¼€å§‹åŠ è½½æ•°æ®ï¼Œç­›é€‰æ¡ä»¶:', currentFilter);

                let apiUrl = `${API_BASE_URL}/violations/analytics`;
                let params = new URLSearchParams();

                // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶æ„å»ºAPIå‚æ•°
                if (currentFilter.timeRange === 'all') {
                    params.append('range', 'all');
                    params.append('all', 'true');
                } else {
                    params.append('range', currentFilter.timeRange);
                }

                const finalUrl = `${apiUrl}?${params.toString()}`;
                console.log('ğŸ“¡ è°ƒç”¨APIè·å–æ•°æ®:', finalUrl);

                const response = await fetch(finalUrl);
                const result = await response.json();

                console.log('ğŸ“¡ æ•°æ®APIå“åº”:', result);

                if (result.success) {
                    globalData = result.data;

                    console.log('ğŸ“Š æ•°æ®ç»“æ„:', {
                        summary: result.data.summary,
                        violations_by_type: result.data.violations_by_type,
                        violations_by_type_keys: Object.keys(result.data.violations_by_type || {}),
                        violations_by_camera: Object.keys(result.data.violations_by_camera || {}),
                        recent_records_count: result.data.recent_records?.length || 0
                    });

                    updateDashboard(result.data);
                    updateCharts();

                    const summary = result.data.summary;
                    console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ:', {
                        records: summary.total_records,
                        violations: summary.total_violations,
                        cameras: summary.active_cameras,
                        violation_types: Object.keys(result.data.violations_by_type || {}).length
                    });

                } else {
                    throw new Error(result.message || 'åŠ è½½æ•°æ®å¤±è´¥');
                }

            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
                showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            } finally {
                isLoading = false;
                document.getElementById('lastUpdate').textContent =
                    'æœ€åæ›´æ–°: ' + new Date().toLocaleTimeString();
            }
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard(data) {
            console.log('ğŸ“Š æ›´æ–°ä»ªè¡¨æ¿æ˜¾ç¤ºæ•°æ®:', {
                summary: data.summary,
                violations_by_type: data.violations_by_type,
                violations_by_camera: data.violations_by_camera
            });

            updateStats(data.summary);
            updateViolationsList(data.violations_by_type);
            updateCamerasList(data.violations_by_camera);
            updateRecentRecords(data.recent_records);
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(summary) {
            document.getElementById('totalViolations').textContent = summary.total_violations || 0;
            document.getElementById('totalRecords').textContent = summary.total_records || 0;
            document.getElementById('activeCameras').textContent = summary.active_cameras || 0;

            const avgViolations = summary.total_records > 0 ?
                (summary.total_violations / summary.total_records).toFixed(1) : '0';
            document.getElementById('avgViolations').textContent = avgViolations;
        }

        // æ›´æ–°è¿è§„ç±»å‹åˆ—è¡¨
        function updateViolationsList(violationsByType) {
            const listElement = document.getElementById('violationsList');

            console.log('ğŸ” æ›´æ–°è¿è§„ç±»å‹åˆ—è¡¨:', violationsByType);

            if (!violationsByType || Object.keys(violationsByType).length === 0) {
                listElement.innerHTML = `
                    <li class="list-item">
                        <div class="item-info">
                            <div class="item-name">æš‚æ— è¿è§„æ•°æ®</div>
                            <div class="item-stats">æ£€æµ‹ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</div>
                        </div>
                        <div class="item-count">0</div>
                    </li>
                `;
                console.log('âš ï¸ è¿è§„ç±»å‹æ•°æ®ä¸ºç©º');
                return;
            }

            // è¿‡æ»¤æœ‰æ•ˆçš„è¿è§„æ•°æ®
            const validViolations = Object.entries(violationsByType)
                .filter(([type, count]) => {
                    const isValid = count > 0 && typeof count === 'number';
                    console.log(`æ£€æŸ¥è¿è§„ç±»å‹ ${type}: è®¡æ•°=${count}, æœ‰æ•ˆ=${isValid}`);
                    return isValid;
                })
                .sort(([,a], [,b]) => b - a);

            console.log('âœ… æœ‰æ•ˆçš„è¿è§„ç±»å‹:', validViolations);

            if (validViolations.length === 0) {
                listElement.innerHTML = `
                    <li class="list-item">
                        <div class="item-info">
                            <div class="item-name">æ‰€æœ‰è¿è§„è®¡æ•°ä¸º0</div>
                            <div class="item-stats">å½“å‰çŠ¶æ€è‰¯å¥½</div>
                        </div>
                        <div class="item-count">0</div>
                    </li>
                `;
                return;
            }

            listElement.innerHTML = validViolations.map(([type, count]) => {
                const displayName = violationMapping[type] || `${type}(åŸå§‹)`;
                console.log(`ğŸ“Š è¿è§„ç±»å‹æ˜ å°„: ${type} -> ${displayName} (${count}æ¬¡)`);

                return `
                    <li class="list-item">
                        <div class="item-info">
                            <div class="item-name">${displayName}</div>
                            <div class="item-stats">å®‰å…¨è¿è§„æ£€æµ‹</div>
                        </div>
                        <div class="item-count violation-count">${count}</div>
                    </li>
                `;
            }).join('');

            console.log(`âœ… è¿è§„ç±»å‹åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œæ˜¾ç¤º ${validViolations.length} ç§è¿è§„ç±»å‹`);
        }

        // æ›´æ–°æ‘„åƒå¤´åˆ—è¡¨ - ç»Ÿä¸€æ ·å¼
        function updateCamerasList(violationsByCamera) {
            const listElement = document.getElementById('camerasList');

            if (!violationsByCamera || Object.keys(violationsByCamera).length === 0) {
                listElement.innerHTML = `
                    <li class="list-item">
                        <div class="item-info">
                            <div class="item-name">æš‚æ— æ‘„åƒå¤´æ•°æ®</div>
                            <div class="item-stats">ç­‰å¾…æ£€æµ‹æ•°æ®</div>
                        </div>
                        <div class="item-count">0</div>
                    </li>
                `;
                return;
            }

            const sortedCameras = Object.entries(violationsByCamera)
                .sort(([,a], [,b]) => b - a);

            listElement.innerHTML = sortedCameras.map(([cameraId, violations]) => `
                <li class="list-item">
                    <div class="item-info">
                        <div class="item-name">${cameraId}</div>
                        <div class="item-stats">è¿è§„æ£€æµ‹æ‘„åƒå¤´</div>
                    </div>
                    <div class="item-count">${violations}</div>
                </li>
            `).join('');
        }

        // æ›´æ–°æœ€è¿‘è®°å½•
        function updateRecentRecords(recentRecords) {
            const tableBody = document.getElementById('recordsTableBody');

            if (!recentRecords || recentRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">æš‚æ— æœ€è¿‘è®°å½•</td></tr>';
                return;
            }

            tableBody.innerHTML = recentRecords.slice(0, 10).map(record => {
                const detectionTime = new Date(record.timestamp).toLocaleString();
                const createdTime = record.created_at ? new Date(record.created_at).toLocaleString() : '--';

                // è§£æè¿è§„ç±»å‹è¯¦æƒ…
                let violationTypesDisplay = 'æ— è¿è§„';
                if (record.violations && Object.keys(record.violations).length > 0) {
                    const violationList = Object.entries(record.violations)
                        .filter(([type, count]) => count > 0)
                        .map(([type, count]) => {
                            const displayName = violationMapping[type] || `${type}(åŸå§‹)`;
                            return `${displayName}(${count}æ¬¡)`;
                        })
                        .join(', ');
                    violationTypesDisplay = violationList || 'æ£€æµ‹è®°å½•';
                } else if (record.total_violations && record.total_violations > 0) {
                    violationTypesDisplay = `æ€»è¿è§„(${record.total_violations}æ¬¡)`;
                }

                return `
                    <tr>
                        <td>${record.camera_id}</td>
                        <td><span class="timestamp">${detectionTime}</span></td>
                        <td><span class="timestamp">${createdTime}</span></td>
                        <td><strong>${record.total_violations || 0}</strong></td>
                        <td>${violationTypesDisplay}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            if (!globalData) {
                console.log('âš ï¸ globalData ä¸ºç©ºï¼Œç­‰å¾…æ•°æ®åŠ è½½...');
                return;
            }

            updateViolationPieChart();
            updateCameraCompareChart();
            updateHourlyDistributionChart();
        }

        function getViolationDisplayName(type) {
            return violationMapping[type] || `${type}(åŸå§‹)`;
        }

        function getViolationColor(type) {
            return violationColors[type] || '#999999';
        }

        // æ›´æ–°è¿è§„ç±»å‹é¥¼å›¾
        function updateViolationPieChart() {
            const violationsByType = globalData.violations_by_type;

            console.log('ğŸ” æ›´æ–°é¥¼å›¾:', violationsByType);

            if (!violationsByType || Object.keys(violationsByType).length === 0) {
                violationPieChart.setOption({
                    title: {
                        text: 'æš‚æ— è¿è§„æ•°æ®',
                        left: 'center',
                        top: 'middle',
                        textStyle: { fontSize: 16, color: '#999' }
                    }
                });
                document.getElementById('violationPieInfo').textContent = 'æ— æ•°æ®';
                return;
            }

            const validData = Object.entries(violationsByType)
                .filter(([type, count]) => {
                    const isValid = count > 0 && typeof count === 'number';
                    console.log(`é¥¼å›¾æ£€æŸ¥è¿è§„ç±»å‹ ${type}: è®¡æ•°=${count}, æœ‰æ•ˆ=${isValid}`);
                    return isValid;
                })
                .map(([type, count]) => {
                    const displayName = getViolationDisplayName(type);
                    console.log(`é¥¼å›¾æ˜ å°„: ${type} -> ${displayName}`);

                    return {
                        name: displayName,
                        value: count,
                        itemStyle: {
                            color: getViolationColor(type)
                        }
                    };
                });

            if (validData.length === 0) {
                violationPieChart.setOption({
                    title: {
                        text: 'æ‰€æœ‰è¿è§„è®¡æ•°ä¸º0',
                        left: 'center',
                        top: 'middle',
                        textStyle: { fontSize: 16, color: '#999' }
                    }
                });
                document.getElementById('violationPieInfo').textContent = 'è®¡æ•°ä¸º0';
                return;
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'center'
                },
                series: [{
                    name: 'è¿è§„ç±»å‹',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '50%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '16',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: validData
                }]
            };

            violationPieChart.setOption(option, true);

            const totalViolations = validData.reduce((sum, item) => sum + item.value, 0);
            document.getElementById('violationPieInfo').textContent = `${totalViolations} æ¬¡è¿è§„`;

            console.log(`âœ… é¥¼å›¾æ›´æ–°å®Œæˆï¼Œæ˜¾ç¤º ${validData.length} ç§è¿è§„ç±»å‹ï¼Œæ€»è®¡ ${totalViolations} æ¬¡`);
        }

        // æ›´æ–°æ‘„åƒå¤´å¯¹æ¯”å›¾
        function updateCameraCompareChart() {
            const violationsByCamera = globalData.violations_by_camera;

            if (!violationsByCamera || Object.keys(violationsByCamera).length === 0) {
                cameraCompareChart.setOption({
                    title: {
                        text: 'æš‚æ— æ‘„åƒå¤´æ•°æ®',
                        left: 'center',
                        top: 'middle',
                        textStyle: {
                            fontSize: 16,
                            color: '#999'
                        }
                    }
                });
                document.getElementById('cameraCompareInfo').textContent = 'æ— æ•°æ®';
                return;
            }

            const sortedCameras = Object.entries(violationsByCamera)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '15%',
                    right: '4%',
                    bottom: '8%',
                    top: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    name: 'è¿è§„æ¬¡æ•°',
                    nameLocation: 'middle',
                    nameGap: 30
                },
                yAxis: {
                    type: 'category',
                    data: sortedCameras.map(([camera, _]) => camera),
                    axisLabel: {
                        interval: 0,
                        fontSize: 12,
                        width: 100,
                        overflow: 'truncate'
                    }
                },
                series: [{
                    name: 'è¿è§„æ¬¡æ•°',
                    type: 'bar',
                    data: sortedCameras.map(([_, count]) => count),
                    itemStyle: {
                        color: function(params) {
                            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
                            return colors[params.dataIndex % colors.length];
                        }
                    },
                    barWidth: '60%'
                }]
            };

            cameraCompareChart.setOption(option, true);
            document.getElementById('cameraCompareInfo').textContent =
                `${Object.keys(violationsByCamera).length}ä¸ªæ‘„åƒå¤´`;
        }

        // æ›´æ–°24å°æ—¶åˆ†å¸ƒå›¾
        function updateHourlyDistributionChart() {
            const violationsByHour = globalData.violations_by_hour || {};

            const hours = [];
            const data = [];

            for (let i = 0; i < 24; i++) {
                hours.push(i + 'æ—¶');
                data.push(violationsByHour[i] || 0);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].name}: ${params[0].value}æ¬¡è¿è§„`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLabel: {
                        interval: 2
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'è¿è§„æ¬¡æ•°'
                },
                series: [{
                    name: 'è¿è§„æ¬¡æ•°',
                    type: 'line',
                    smooth: true,
                    data: data,
                    itemStyle: {
                        color: '#667eea'
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(102, 126, 234, 0.5)' },
                                { offset: 1, color: 'rgba(102, 126, 234, 0.1)' }
                            ]
                        }
                    }
                }]
            };

            hourlyDistributionChart.setOption(option, true);

            const totalHourlyViolations = data.reduce((a, b) => a + b, 0);
            document.getElementById('hourlyDistributionInfo').textContent =
                `${totalHourlyViolations} æ¬¡è¿è§„`;
        }

        // AIæŸ¥è¯¢ç›¸å…³åŠŸèƒ½
        function setAIQuery(query) {
            document.getElementById('aiQueryInput').value = query;
        }

        function clearAIQuery() {
            document.getElementById('aiQueryInput').value = '';
            const resultDiv = document.getElementById('aiAnalysisResult');
            resultDiv.style.display = 'none';
        }

        // è·å–æ—¶é—´èŒƒå›´æè¿°çš„å·¥å…·å‡½æ•°
        function getTimeRangeDescription(timeRangeHours, queryAllData) {
            console.log('ç”Ÿæˆæ—¶é—´èŒƒå›´æè¿°:', { timeRangeHours, queryAllData });

            // ä¿®å¤ï¼šç¡®ä¿å‚æ•°æœ‰æ•ˆæ€§
            if (queryAllData === true || timeRangeHours === 0 || timeRangeHours === null || timeRangeHours === undefined) {
                return 'æ‰€æœ‰å†å²æ•°æ®';
            }

            // ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
            const hours = parseInt(timeRangeHours);
            if (isNaN(hours) || hours <= 0) {
                return 'æœ€è¿‘24å°æ—¶'; // é»˜è®¤å€¼
            }

            if (hours === 1) {
                return 'æœ€è¿‘1å°æ—¶';
            } else if (hours === 24) {
                return 'æœ€è¿‘24å°æ—¶';
            } else if (hours === 48) {
                return 'æœ€è¿‘48å°æ—¶';
            } else if (hours === 72) {
                return 'æœ€è¿‘3å¤©';
            } else if (hours === 168) {
                return 'æœ€è¿‘7å¤©';
            } else if (hours === 720) {
                return 'æœ€è¿‘30å¤©';
            } else if (hours >= 24) {
                const days = Math.floor(hours / 24);
                if (days === 1) {
                    return 'æœ€è¿‘1å¤©';
                } else {
                    return `æœ€è¿‘${days}å¤©`;
                }
            } else {
                return `æœ€è¿‘${hours}å°æ—¶`;
            }
        }

        // ä¿®å¤AIæŸ¥è¯¢ä¸­çš„æ—¶é—´èŒƒå›´å¤„ç†
        async function submitAIQuery() {
            const queryInput = document.getElementById('aiQueryInput');
            const queryBtn = document.getElementById('queryBtn');
            const resultDiv = document.getElementById('aiAnalysisResult');
            const contentDiv = document.getElementById('aiResultContent');
            const timeRange = document.getElementById('queryTimeRange').value;

            const query = queryInput.value.trim();

            if (!query) {
                showMessage('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜', 'error');
                return;
            }

            queryBtn.innerHTML = 'åˆ†æä¸­...';
            queryBtn.disabled = true;

            contentDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <div style="margin-top: 10px; color: #6c757d;">AIæ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</div>
                </div>
            `;
            resultDiv.style.display = 'block';

            try {
                // ä¿®å¤ï¼šç¡®ä¿æ—¶é—´èŒƒå›´å‚æ•°æ­£ç¡®å¤„ç†
                let timeRangeHours = parseInt(timeRange);

                // å¦‚æœæ—¶é—´èŒƒå›´æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼
                if (isNaN(timeRangeHours) || timeRangeHours < 0) {
                    timeRangeHours = 24;
                    console.warn('æ—¶é—´èŒƒå›´å‚æ•°æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤24å°æ—¶');
                }

                const requestData = {
                    query: query,
                    time_range_hours: timeRangeHours
                };

                console.log('AIæŸ¥è¯¢è¯·æ±‚æ•°æ®:', requestData);
                console.log('åŸå§‹æ—¶é—´èŒƒå›´é€‰æ‹©:', timeRange);
                console.log('å¤„ç†åçš„æ—¶é—´èŒƒå›´:', timeRangeHours);

                const response = await fetch(`${JANUS_API_URL}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                console.log('AIæŸ¥è¯¢å“åº”:', result);

                if (result.success) {
                    displayAIAnalysisResult(result);
                } else {
                    throw new Error(result.error || 'AIåˆ†æå¤±è´¥');
                }

            } catch (error) {
                console.error('AIæŸ¥è¯¢å¤±è´¥:', error);
                contentDiv.innerHTML = `
                    <div class="message message-error" style="margin: 0;">
                        æŸ¥è¯¢å¤±è´¥: ${error.message}
                        <br><small>è¯·æ£€æŸ¥AIæœåŠ¡çŠ¶æ€æˆ–ç¨åé‡è¯•</small>
                    </div>
                `;
            } finally {
                queryBtn.innerHTML = 'AIåˆ†æ';
                queryBtn.disabled = false;
            }
        }

        // AIåˆ†æç»“æœæ˜¾ç¤ºå‡½æ•°
        function displayAIAnalysisResult(result) {
            const contentDiv = document.getElementById('aiResultContent');
            const analysis = result.analysis;
            const dataSummary = result.data_summary;
            const queryInfo = result.query_info;

            console.log('æ˜¾ç¤ºAIåˆ†æç»“æœ:', result);
            console.log('æŸ¥è¯¢ä¿¡æ¯:', queryInfo);
            console.log('æ•°æ®æ‘˜è¦:', dataSummary);

            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">æŸ¥è¯¢é—®é¢˜:</div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border-left: 3px solid #667eea;">
                        ${result.query}
                    </div>
                </div>
            `;

            // æ—¶é—´èŒƒå›´æ˜¾ç¤ºé€»è¾‘
            let rangeDesc = 'æœ€è¿‘24å°æ—¶'; // é»˜è®¤å€¼

            if (dataSummary && dataSummary.time_description) {
                // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„æ—¶é—´æè¿°
                rangeDesc = dataSummary.time_description;
                console.log('ä½¿ç”¨åç«¯æ—¶é—´æè¿°:', rangeDesc);
            } else if (queryInfo) {
                // å¤‡é€‰ï¼šæ ¹æ®æŸ¥è¯¢ä¿¡æ¯ç”Ÿæˆæè¿°
                rangeDesc = getTimeRangeDescription(
                    queryInfo.smart_detected_hours || queryInfo.user_selected_hours,
                    queryInfo.query_all_data
                );
                console.log('ä½¿ç”¨æŸ¥è¯¢ä¿¡æ¯ç”Ÿæˆæè¿°:', rangeDesc);
            }

            html += `
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">åˆ†æèŒƒå›´:</div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; font-size: 14px; color: #1565c0;">
                        åŸºäº${rangeDesc}çš„æ•°æ®
                    </div>
                </div>
            `;

            if (analysis.direct_answer) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">AIå›ç­”:</div>
                        <div style="background: white; padding: 15px; border-radius: 6px; font-size: 16px; line-height: 1.6;">
                            ${analysis.direct_answer}
                        </div>
                    </div>
                `;
            }

            if (analysis.detailed_explanation) {
                // å¤„ç†è¯¦ç»†åˆ†æä¸­çš„æ¢è¡Œç¬¦
                const formattedExplanation = analysis.detailed_explanation
                    .replace(/\n/g, '<br>')
                    .replace(/â€¢\s*/g, 'â€¢ ');

                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">è¯¦ç»†åˆ†æ:</div>
                        <div style="background: white; padding: 15px; border-radius: 6px; line-height: 1.6; color: #6c757d;">
                            ${formattedExplanation}
                        </div>
                    </div>
                `;
            }

            if (analysis.suggestions && analysis.suggestions.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">æ”¹è¿›å»ºè®®:</div>
                        <div style="background: white; padding: 15px; border-radius: 6px;">
                            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                ${analysis.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }

            if (dataSummary) {
                html += `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e1e5e9;">
                        <div style="font-weight: 600; color: #495057; margin-bottom: 8px;">æ•°æ®æ¦‚è§ˆ:</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #667eea;">${dataSummary.total_violations || 0}</div>
                                <div style="font-size: 12px; color: #6c757d;">æ€»è¿è§„</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #667eea;">${dataSummary.total_records || 0}</div>
                                <div style="font-size: 12px; color: #6c757d;">æ£€æµ‹è®°å½•</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #667eea;">${dataSummary.active_cameras || 0}</div>
                                <div style="font-size: 12px; color: #6c757d;">æ´»è·ƒæ‘„åƒå¤´</div>
                            </div>
                        </div>
                    </div>
                `;
            }

<!--            // æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒå¯ç§»é™¤ï¼‰-->
<!--            if (queryInfo) {-->
<!--                html += `-->
<!--                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 12px; color: #6c757d;">-->
<!--                        <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>-->
<!--                        ç”¨æˆ·é€‰æ‹©: ${queryInfo.user_selected_hours}å°æ—¶ | -->
<!--                        æ™ºèƒ½æ£€æµ‹: ${queryInfo.smart_detected_hours}å°æ—¶ | -->
<!--                        æŸ¥è¯¢å…¨éƒ¨: ${queryInfo.query_all_data ? 'æ˜¯' : 'å¦'} | -->
<!--                        æ—¶é—´è°ƒæ•´: ${queryInfo.time_range_adjusted ? 'æ˜¯' : 'å¦'}-->
<!--                    </div>-->
<!--                `;-->
<!--            }-->

            contentDiv.innerHTML = html;
        }

        // æ¸…ç©ºæ•°æ®
        async function clearData() {
            if (!confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰è¿è§„æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            try {
                showMessage('æ­£åœ¨æ¸…ç©ºæ•°æ®...', 'info');

                const response = await fetch(`${API_BASE_URL}/violations/clear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`æ•°æ®å·²æ¸…ç©º - åˆ é™¤äº† ${result.cleared_records || 0} æ¡è®°å½•`, 'success');
                    setTimeout(() => {
                        if (!isLoading) {
                            loadData();
                        }
                    }, 1000);
                } else {
                    throw new Error(result.message || 'æ¸…ç©ºæ•°æ®å¤±è´¥');
                }

            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                showMessage('æ¸…ç©ºæ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            clearMessages();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `
                <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : type === 'warning' ? 'âš ' : 'â„¹'}</span>
                ${message}
            `;

            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.children[1]);
        }

        // æ¸…é™¤æ¶ˆæ¯
        function clearMessages() {
            const messages = document.querySelectorAll('.message');
            messages.forEach(msg => msg.remove());
        }

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !isLoading) {
                loadData();
            }
        });
    </script>
</body>
</html>